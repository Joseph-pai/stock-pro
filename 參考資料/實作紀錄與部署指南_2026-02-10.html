<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作紀錄備份 (2026-02-10) - 完整版</title>
    <!-- Mermaid for Flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({ startOnLoad: true, theme: 'dark' });</script>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #a855f7;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.9);
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --code-bg: #1e293b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(168, 85, 247, 0.1));
            border-radius: 40px;
            border: 1px solid var(--border);
        }

        h1 {
            font-size: 2.8rem;
            background: linear-gradient(to right, #60a5fa, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0 0 10px 0;
            letter-spacing: -1px;
        }

        .date-badge {
            display: inline-block;
            padding: 6px 16px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid var(--primary);
            border-radius: 30px;
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 800;
        }

        nav {
            position: sticky;
            top: 20px;
            z-index: 1000;
            margin-bottom: 40px;
        }

        nav ul {
            list-style: none;
            padding: 10px;
            margin: 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            flex-wrap: wrap;
        }

        nav a {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 8px 14px;
            border-radius: 40px;
            transition: all 0.2s;
        }

        nav a:hover {
            color: white;
            background: var(--primary);
        }

        section {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border);
            border-radius: 32px;
            padding: 50px;
            margin-bottom: 50px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        h2 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        h3 {
            color: #60a5fa;
            margin-top: 40px;
            border-left: 4px solid #60a5fa;
            padding-left: 15px;
        }

        h4 {
            color: #94a3b8;
            margin-top: 25px;
            font-size: 1.1rem;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
        }

        th,
        td {
            text-align: left;
            padding: 14px;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        /* Code Blocks */
        pre {
            background: var(--code-bg);
            padding: 24px;
            border-radius: 16px;
            overflow-x: auto;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            margin: 20px 0;
            white-space: pre;
        }

        .diff-add {
            color: #4ade80;
        }

        .diff-remove {
            color: #f87171;
        }

        /* Alerts */
        .alert {
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            border-left: 5px solid;
        }

        .alert-important {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary);
            color: #93c5fd;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #fcd34d;
        }

        .alert-tip {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #6ee7b7;
        }

        /* Checkboxes */
        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-item {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 10px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--primary);
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            top: 3px;
        }

        .checkbox.checked {
            background: var(--primary);
        }

        .checkbox.checked::after {
            content: "✓";
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .mermaid {
            background: #111;
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            text-align: center;
        }

        footer {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            padding: 60px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>工作紀錄整合備份</h1>
            <div class="date-badge">2026-02-10 完整紀錄</div>
        </header>

        <nav>
            <ul>
                <li><a href="#redis-plan">1. Redis 實施計劃</a></li>
                <li><a href="#netlify-guide">2. Netlify 部署指南</a></li>
                <li><a href="#impl-plan">3. 飆股邏輯強化計劃</a></li>
                <li><a href="#task-checklist">4. 任務檢核清單</a></li>
                <li><a href="#summary-record">5. 今日實作總結</a></li>
            </ul>
        </nav>

        <!-- 1. Redis Implementation Plan -->
        <section id="redis-plan">
            <h2>1. 系統進階方案：導入 Redis 全局緩存實施計劃</h2>
            <p>本計劃旨在探討如何透過導入 Redis（遠端字典服務）將系統從「客戶端分段暫存」升級為「服務端全局緩存」，以極大化數據讀取速度並降低外部 API 負擔。</p>

            <h3>1. 核心目標</h3>
            <ul>
                <li><strong>消除網路延時</strong>：將數據抓取延遲從 500ms+ 降低至 20ms 以內。</li>
                <li><strong>節節省 API 配額</strong>：減少對 FinMind、TWSE 等外部資源的重複請求。</li>
                <li><strong>全局共享</strong>：實現不同設備（手機、電腦）間的緩存共享。</li>
                <li><strong>預熱機制</strong>：開盤前自動準備數據，實現秒級掃描。</li>
            </ul>

            <h3>2. 緩存鍵 (Key) 設計架構</h3>
            <table>
                <thead>
                    <tr>
                        <th>數據類型</th>
                        <th>Redis Key 範例</th>
                        <th>TTL (過期時間)</th>
                        <th>說明</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>市場快照</strong></td>
                        <td>tsbs:snap:{mkt}:{sector}</td>
                        <td>1 小時</td>
                        <td>存放 TWSE/TPEX 類股快照</td>
                    </tr>
                    <tr>
                        <td><strong>歷史 K 線</strong></td>
                        <td>tsbs:hist:{symbol}</td>
                        <td>24 小時</td>
                        <td>存放個股歷史交易數據</td>
                    </tr>
                    <tr>
                        <td><strong>AI 分析</strong></td>
                        <td>tsbs:ai:{symbol}:{date}</td>
                        <td>12 小時</td>
                        <td>存放昂貴的 AI 深度分析結果</td>
                    </tr>
                    <tr>
                        <td><strong>產業映射</strong></td>
                        <td>tsbs:map:industry</td>
                        <td>7 天</td>
                        <td>變動頻率極低的映射表</td>
                    </tr>
                </tbody>
            </table>

            <h3>3. 資料流邏輯 (Read-Aside Pattern)</h3>
            <div class="mermaid">
                graph TD
                A[API 請求檢索] --> B{檢查 Redis 緩存}
                B -- 命中 (Hit) --> C[回傳 Redis 數據]
                B -- 未命中 (Miss) --> D[調用外部 API 抓取]
                D --> E[寫入 Redis 並設 TTL]
                E --> F[回傳 最新數據]
            </div>

            <h3>4. 技術實施點</h3>
            <ul>
                <li><strong>緩存穿透保護</strong>：針對不存在的代號，在 Redis 存入空值短暫過期。</li>
                <li><strong>自動失效控制</strong>：利用 Redis EXPIRE 屬性，確保歷史數據在收盤後自動更新。</li>
            </ul>

            <h3>5. 實施效益</h3>
            <div class="alert alert-tip">
                <strong>性能提升</strong>：對於使用者來說，掃描 200 支股票的等待時間將從「感覺有在跑」變成「瞬間完成」。<br>
                <strong>穩定性</strong>：即使外部 API 暫時當機，只要 Redis 內有緩存，系統依然能提供正常的數據服務。
            </div>
        </section>

        <!-- 2. Netlify Deployment Guide -->
        <section id="netlify-guide">
            <h2>2. Netlify 部署調整指南 (針對 Redis 緩存)</h2>
            <p>由於 Netlify 是基於 Serverless Functions 的架構，部署時需要注意以下關鍵點：</p>

            <h3>1. 外部 Redis 服務 (必要)</h3>
            <p>Netlify 的伺服器本身不提供 Redis。建議使用 <strong>Upstash</strong>。</p>

            <h3>2. Vercel KV 詳細操作步驟</h3>
            <ol>
                <li>登入 Vercel 並連結 GitHub 倉庫。</li>
                <li>點擊 <strong>Storage</strong> 分頁，建立一個 <strong>KV Database</strong>。</li>
                <li>選擇區域（建議 us-east-1）。</li>
                <li>在儀表板獲取 <code>REDIS_URL</code>。</li>
            </ol>

            <h3>3. Netlify 環境變數設置</h3>
            <ul style="list-style: none;">
                <li><code>REDIS_URL</code>：填入外部 Redis 連結。</li>
                <li><code>NEXT_PUBLIC_FINMIND_TOKEN</code>：FinMind API Key。</li>
            </ul>

            <div class="alert alert-warning">
                <strong>特別注意</strong>：目前 <code>ioredis</code> 在 Serverless 環境中，每個新實例會建立一次連接。若連結數過大，建議更換為
                <code>@upstash/redis</code> (HTTP 協議)。
            </div>
        </section>

        <!-- 3. Implementation Plan -->
        <section id="impl-plan">
            <h2>3. 飆股選股邏輯強化計劃</h2>

            <div class="alert alert-important">
                <strong>FinMind API 權限限制</strong>：新增的 <code>TaiwanStockMarginPurchaseShortSale</code> dataset 可能需要升級 API
                方案。如果受限，將以 graceful fallback 運作。
            </div>

            <h3>改進內容詳情</h3>

            <h4>改進 1：延長 VRatio 基線期（5 天 → 20 天）</h4>
            <p>原因：20 天更能代表常態量能。</p>
            <pre><code> export function calculateVRatio(volumes: number[]): number {
<span class="diff-remove">-    if (volumes.length < 5) return 0;</span>
<span class="diff-add">+    if (volumes.length < 21) return 0;</span>
     const observationAvg = volumes[volumes.length - 1];
<span class="diff-add">+    const baselineVolumes = volumes.slice(-21, -1);</span>
     const baselineAvg = baselineVolumes.reduce((a, b) => a + b, 0) / baselineVolumes.length;
     return baselineAvg === 0 ? 0 : observationAvg / baselineAvg;
 }</code></pre>

            <h4>改進 2：新增融資融券軋空信號</h4>
            <p>原因：滿足理論「融資溫和增加 + 股價同步上升」要求。</p>
            <pre><code>// 核心函數
export function checkMarginSqueezeSignal(marginData, priceData) {
    // ...
    const hasSignal = allNonNeg && avgChange > 0 && priceUp;
    return { hasSignal, marginTrend, score };
}</code></pre>

            <h4>改進 3：新增跳空缺口 (Gap Up) 判斷</h4>
            <p>邏輯：今日最低 > 昨日最高。</p>
            <pre><code>export function checkGapUp(todayLow, prevHigh) {
    const gap = todayLow - prevHigh;
    return { isGapUp: gap > 0, gapPercent: gap / prevHigh };
}</code></pre>

            <h4 style="color: #60a5fa; border-left: 4px solid #60a5fa; padding-left: 15px;">改進 4：月營收「創近期新高」判斷</h4>
            <p>原因：理論要求營收「創下近期新高」，目前只計算成長率，不判斷絕對值。</p>
            <pre><code>// 新高判斷：最新營收是否為近 6 個月最高
let isRevenueNewHigh = false;
if (sorted.length >= 6) {
    const recent6 = sorted.slice(-6).map((r: any) => Number(getRevenue(r)) || 0);
    isRevenueNewHigh = latestRev >= Math.max(...recent6) && latestRev > 0;
    if (isRevenueNewHigh) revenueBonusPoints += 3; // 額外加分
}</code></pre>

            <h4>改進 5：調整評分權重與 UI 展示</h4>
            <table>
                <tr>
                    <td>量能激增</td>
                    <td>30 分</td>
                </tr>
                <tr>
                    <td>均線糾結</td>
                    <td>22 分</td>
                </tr>
                <tr>
                    <td>籌碼集中</td>
                    <td>22 分</td>
                </tr>
                <tr>
                    <td>融資軋空</td>
                    <td>11 分</td>
                </tr>
                <tr>
                    <td>基本面</td>
                    <td>15 分</td>
                </tr>
            </table>
        </section>

        <!-- 4. Task List -->
        <section id="task-checklist">
            <h2>4. 任務清單檢核表 (Task Checklist)</h2>
            <ul class="task-list">
                <li class="task-item">
                    <div class="checkbox checked"></div> 延長 VRatio 基線期：5 天 → 20 天
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 在 finmind.ts 新增 getMarginTrading() 方法
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 在 engine.ts 新增 checkMarginSqueezeSignal() 函數
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 在 engine.ts 新增 checkGapUp() 函數
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 整合月營收「創近期新高」檢查邏輯
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 調整 scanner.ts 五維評分系統
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 前端 StockCard 增加新信號 Tag 顯示
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 新增首頁「使用說明 & 勝率分析」Modal
                </li>
                <li class="task-item">
                    <div class="checkbox checked"></div> 更新品牌為「五維評分引擎 V8.2」及版權聲明
                </li>
            </ul>
        </section>

        <!-- 5. Summary Record -->
        <section id="summary-record">
            <h2>5. 今日實作總結 (RECORDS_2026-02-10.md)</h2>
            <p>整合了今日針對「飆股選股邏輯強化」任務的所有實作內容。</p>
            <ul>
                <li>✅ <strong>理論對標</strong>：完全覆蓋用戶提到的盤整、放量、投信、融資、營收五大理論面向。</li>
                <li>✅ <strong>上櫃兼容</strong>：數據與算法已同步優化支持上市與上櫃股票。</li>
                <li>✅ <strong>UI 優化</strong>：新增專業彈窗說明，明確提示贏率分析與操盤戰略。</li>
            </ul>
        </section>

        <footer>
            備份文件由 Antigravity AI 生成 | Joseph PAI @2026 所有權利保留
        </footer>
    </div>

    <script>
        // Smooth scrolling
        document.querySelectorAll('nav a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>

</html>